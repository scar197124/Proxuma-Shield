<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Proxuma Shield — Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>

  * { box-sizing: border-box; }

  :root {
    --bg-color: #000000;
    --card-bg: #000000;
    --border-color: #39ff14;
    --text-color: #ffffff;
    --muted-color: rgba(245,245,245,0.7);
    --accent-color: #39ff14;
    --chip-bg: #000000;
    --button-bg: #000000;
    --button-text: #39ff14;
    --button-border: #39ff14;
    --meter-border: #39ff14;
  }

  :root[data-theme="neon"] {
    --bg-color: #000000;
    --card-bg: #000000;
    --border-color: #39ff14;
    --text-color: #ffffff;
    --muted-color: rgba(245,245,245,0.7);
    --accent-color: #39ff14;
    --chip-bg: #000000;
    --button-bg: #000000;
    --button-text: #39ff14;
    --button-border: #39ff14;
    --meter-border: #39ff14;
  }

  :root[data-theme="light"] {
    --bg-color: #ffffff;
    --card-bg: #ffffff;
    --border-color: #000000;
    --text-color: #000000;
    --muted-color: rgba(0,0,0,0.65);
    --accent-color: #000000;
    --chip-bg: #ffffff;
    --button-bg: #ffffff;
    --button-text: #000000;
    --button-border: #000000;
    --meter-border: #000000;
  }

  :root[data-theme="yellow"] {
    --bg-color: #000000;
    --card-bg: #000000;
    --border-color: #fff200;
    --text-color: #ffffff;            /* all text white */
    --muted-color: rgba(255,255,255,0.7);
    --accent-color: #fff200;          /* accents stay yellow */
    --chip-bg: #000000;
    --button-bg: #000000;
    --button-text: #ffffff;           /* button text white */
    --button-border: #fff200;
    --meter-border: #fff200;
  }

  body {
    background: var(--bg-color);
    color: var(--text-color);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin:0;
    padding:0;
  }
  header {
    padding:14px 18px;
    border-bottom:1px solid var(--border-color);
    background: rgba(0,0,0,0);
    backdrop-filter: blur(10px);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .header-left {
    flex-direction:column; align-items:flex-start;
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .logo {
    font-size:20px;
    letter-spacing:2px;
    font-weight:600;
  }
  .badge {
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:2px solid var(--border-color);
    text-transform:uppercase;
    opacity:0.9;
  }
  .header-right {
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .theme-label {
    font-size:11px;
    opacity:0.8;
  }
  .theme-select {
    padding:5px 8px;
    border-radius:999px;
    border:2px solid var(--border-color);
    background: var(--bg-color);
    color: var(--text-color);
    font-size:11px;
    outline:none;
  }

  .wrapper {
    max-width:1100px;
    margin:0 auto;
    padding:20px 14px 36px;
  }

  /* Mobile-stacked layout: everything flows in a single column on all screen sizes */
  .stacked {
    display:flex;
    flex-direction:column;
    gap:18px;
  }

  .section {
    background: radial-gradient(circle at top left,
      rgba(0,255,102,0.07),
      transparent 55%);
    background-color: var(--card-bg);
    padding:18px 18px 20px;
    border-radius:14px;
    border:2px solid var(--border-color);
    box-shadow:0 0 18px rgba(0,0,0,0.45);
    backdrop-filter: blur(6px);
  }
  .section h2 {
    margin:0 0 8px;
    font-size:16px;
    letter-spacing:0.5px;
  }
  .section p.desc {
    margin:0 0 12px;
    font-size:14px;
    color: var(--muted-color);
  }

  label {
    display:block;
    margin:9px 0 5px;
    font-size:13px;
    opacity:0.9;
  }

  input, textarea, select {
    width:100%;
    padding:9px 10px;
    border-radius:9px;
    border:2px solid var(--border-color);
    background: rgba(0,0,0,0.75);
    color: var(--text-color);
    font-family:inherit;
    font-size:13px;
    outline:none;
  }
  :root[data-theme="light"] input,
  :root[data-theme="light"] textarea,
  :root[data-theme="light"] select {
    background:#f9f9f9;
  }
  input:focus, textarea:focus, select:focus {
    box-shadow:0 0 0 1px var(--accent-color);
  }
  textarea { min-height:90px; resize:vertical; }
  .inline {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .inline > * { flex:1 1 120px; }

  button {
    margin-top:14px;
    width:100%;
    padding:10px 13px;
    background: var(--button-bg);
    color: var(--button-text);
    border:2px solid var(--button-border);
    border-radius:999px;
    font-size:14px;
    cursor:pointer;
    font-weight:500;
    letter-spacing:0.4px;
    transition: background 0.15s ease, transform 0.08s ease, box-shadow 0.15s ease;
  }
  button:hover {
    background: rgba(0,0,0,0.85);
    box-shadow:0 0 10px rgba(0,255,102,0.2);
  }
  :root[data-theme="light"] button:hover {
    background:#f0f0f0;
    box-shadow:0 0 8px rgba(0,0,0,0.18);
  }
  :root[data-theme="yellow"] button:hover {
    background:#161600;
    box-shadow:0 0 12px rgba(255,234,0,0.35);
  }
  button:active { transform:translateY(1px); }

  .pill-row {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:7px;
  }
  .pill {
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    border:2px solid var(--border-color);
    color: var(--muted-color);
    background: rgba(0,0,0,0.4);
  }
  :root[data-theme="light"] .pill {
    background:#f6f6f6;
  }

  .status-bar {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-top:4px;
  }
  .score {
    font-size:28px;
    font-weight:600;
  }
  .risk-tag {
    padding:5px 10px;
    border-radius:999px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:0.6px;
    border:2px solid var(--border-color);
  }
  .risk-low { background:rgba(0,255,102,0.12); }
  .risk-medium { background:rgba(210,160,0,0.12); }
  .risk-high { background:rgba(255,85,85,0.12); }

  :root[data-theme="light"] .risk-low { background:rgba(0,200,80,0.09); }
  :root[data-theme="light"] .risk-medium { background:rgba(210,160,0,0.12); }
  :root[data-theme="light"] .risk-high { background:rgba(200,40,40,0.13); }

  .meter-shell {
    margin-top:10px;
    width:100%;
    height:9px;
    border-radius:999px;
    background: rgba(0,0,0,0.7);
    overflow:hidden;
    border:2px solid var(--meter-border);
  }
  :root[data-theme="light"] .meter-shell {
    background:#f2f2f2;
  }
  .meter-fill {
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#39ff14,#a2ff00,#fff200,#ff5555);
    transition:width 0.45s ease-out;
  }
  :root[data-theme="yellow"] .meter-fill {
    background:linear-gradient(90deg,#fff200,#ffe700,#ffd500,#ffbb00);
  }
  :root[data-theme="light"] .meter-fill {
    background:linear-gradient(90deg,#222,#666,#999,#000);
  }

  .mini-risk-grid {
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr;
    gap:6px;
  }
  .mini-risk-row {
    display:flex;
    align-items:center;
    gap:8px;
    font-size:11px;
  }
  .mini-risk-label {
    width:110px;
    color:var(--muted-color);
  }
  .mini-meter-shell {
    flex:1;
    height:10px;
    border-radius:999px;
    border:1px solid var(--meter-border);
    background:rgba(0,0,0,0.7);
    overflow:hidden;
  }
  :root[data-theme="light"] .mini-meter-shell {
    background:#f2f2f2;
  }
  .mini-meter-fill {
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#39ff14,#fff200,#ff5555);
    transition:width 0.4s ease-out;
  }

  .mini-risk-value {
    width:42px;
    text-align:right;
    font-size:11px;
  }

  .meta-grid {
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
    margin-top:10px;
  }
  .meta-box {
    background: rgba(0,0,0,0.6);
    border-radius:9px;
    padding:9px 10px;
    border:2px solid var(--border-color);
    font-size:11px;
  }
  :root[data-theme="light"] .meta-box {
    background:#fafafa;
  }
  .meta-label {
    color: var(--muted-color);
    margin-bottom:2px;
  }
  .meta-value {
    font-size:13px;
  }
  .chip {
    display:inline-block;
    font-size:10px;
    padding:3px 7px;
    border-radius:999px;
    border:2px solid var(--border-color);
    margin-top:4px;
    color: var(--muted-color);
  }

  .output-block {
    margin-top:10px;
    padding:9px 10px;
    border-radius:9px;
    background: rgba(0,0,0,0.7);
    border:2px solid var(--border-color);
    font-size:14px;
    line-height:1.5;
    color: var(--text-color);
  }
  :root[data-theme="light"] .output-block {
    background:#fafafa;
  }
  .collapse-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    cursor:pointer;
    user-select:none;
  }
  .collapse-header .label {
    font-size:11px;
    color: var(--muted-color);
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  .chevron {
    font-size:14px;
    margin-left:8px;
    transition:transform 0.18s ease;
  }
  .collapse-body {
    margin-top:6px;
    font-size:14px;
  }
  .output-block.collapsed .collapse-body {
    display:none;
  }
  .output-block.collapsed .chevron {
    transform:rotate(-90deg);
  }
  .muted {
    color: var(--muted-color);
  }

  .history-wrapper {
    margin-top:18px;
  }
  .history-list {
    margin-top:8px;
    display:flex;
    flex-direction:column;
    gap:8px;
    max-height:260px;
    overflow-y:auto;
  }
  .history-item {
    border-radius:9px;
    border:2px solid var(--border-color);
    padding:7px 9px;
    background: rgba(0,0,0,0.65);
    font-size:11px;
  }
  :root[data-theme="light"] .history-item {
    background:#fbfbfb;
  }
  .history-top {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:2px;
  }
  .history-url {
    font-size:11px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .history-tag {
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    border:2px solid var(--border-color);
  }
  .history-meta {
    font-size:10px;
    color: var(--muted-color);
    display:flex;
    justify-content:space-between;
    gap:6px;
    flex-wrap:wrap;
  }

  footer {
    padding:11px;
    text-align:center;
    font-size:11px;
    color: var(--muted-color);
    border-top:2px solid var(--border-color);
    background: var(--bg-color);
  }

  .nav-links {
    display:flex;
    align-items:center;
    gap:12px;
    font-size:14px;
    flex-wrap:wrap;
  }
  .nav-link {
    text-decoration:none;
    color: var(--muted-color);
    padding:4px 9px;
    border-radius:999px;
    border:1px solid transparent;
    transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
  }
  .nav-link:hover {
    color: var(--accent-color);
    background: rgba(255,255,255,0.05);
  }
  .nav-link.nav-active {
    color: var(--accent-color);
    border-color: var(--accent-color);
    background: rgba(0,0,0,0.4);
  }

</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo">PROXUMA SHIELD</div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">Home</a>
      <a href="about.html" class="nav-link">About</a>
      <a href="scanner.html" class="nav-link nav-active">Scanner</a>
    </nav>
  </div>
  <div class="header-right">
    <span class="theme-label">Theme</span>
    <select id="themeSelect" class="theme-select">
      <option value="neon">Neon Green</option>
      <option value="light">White Mode</option>
      <option value="yellow">High-Contrast Yellow</option>
    </select>
  </div>
</header>

<div class="wrapper">
  <div class="stacked">
    <!-- INPUT SIDE -->
    <section class="section">
      <h2>Input Layer</h2>
      <p class="desc">
        Paste a URL and optional HTML. Shield v1.0 Razor++ runs local-only heuristic checks.
        It does not contact any external server and is designed to read cleanly on phones and desktops.
      </p>

      <label for="url">URL to analyze</label>
      <input id="url" type="text" placeholder="https://example.com/login">

      <div class="inline" style="margin-top:10px;">
        <div>
          <label for="profile">Context profile</label>
          <select id="profile">
            <option value="generic">Generic browsing</option>
            <option value="login">Login / account access</option>
            <option value="payment">Payment / checkout</option>
            <option value="email">Email link</option>
          </select>
        </div>
        <div>
          <label for="sensitivity">Data sensitivity</label>
          <select id="sensitivity">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>

      <label for="html">Paste raw HTML (optional)</label>
      <textarea id="html" placeholder="&lt;html&gt;...&lt;/html&gt;"></textarea>

      <label for="notes">Notes (optional)</label>
      <textarea id="notes" placeholder="Why are you checking this link? Any suspicious behavior? (kept local only)"></textarea>

      <button id="scanBtn">Run Razor++ Scan</button>

      <div class="pill-row">
        <div class="pill">No external requests</div>
        <div class="pill">Heuristic engine v1.0 Razor++ · Lookalike aware</div>
        <div class="pill">Layout: Mobile-stacked</div>
      </div>
    </section>

    <!-- RISK SNAPSHOT -->
    <section class="section">
      <h2>Risk Snapshot</h2>
      <p class="desc">
        High-level risk with structured URL and HTML signals, tuned for phishing, scams, and credential traps — now including lookalike awareness and split risk lanes.
      </p>

      <div class="status-bar">
        <div>
          <div style="font-size:11px; color:var(--muted-color);">Overall risk score</div>
          <div class="score" id="scoreValue">–</div>
        </div>
        <div class="risk-tag" id="riskTag">Waiting for scan</div>
      </div>

      <div class="meter-shell">
        <div class="meter-fill" id="meterFill"></div>
      </div>

      <div class="mini-risk-grid">
        <div class="mini-risk-row">
          <div class="mini-risk-label">Credential theft</div>
          <div class="mini-meter-shell"><div class="mini-meter-fill" id="credMeter"></div></div>
          <div class="mini-risk-value" id="credValue">–</div>
        </div>
        <div class="mini-risk-row">
          <div class="mini-risk-label">Financial theft</div>
          <div class="mini-meter-shell"><div class="mini-meter-fill" id="finMeter"></div></div>
          <div class="mini-risk-value" id="finValue">–</div>
        </div>
        <div class="mini-risk-row">
          <div class="mini-risk-label">Malware / exploit</div>
          <div class="mini-meter-shell"><div class="mini-meter-fill" id="malMeter"></div></div>
          <div class="mini-risk-value" id="malValue">–</div>
        </div>
      </div>

      <div class="meta-grid">
        <div class="meta-box">
          <div class="meta-label">Connection</div>
          <div class="meta-value" id="httpsMeta">–</div>
          <div class="chip" id="domainMeta">Domain: –</div>
        </div>
        <div class="meta-box">
          <div class="meta-label">Structure &amp; signals</div>
          <div class="meta-value" id="structureMeta">–</div>
          <div class="chip" id="extrasMeta">Signals: –</div>
        </div>
      </div>
    </section>

    <!-- EXPLANATORY BLOCKS -->
    <section class="section">
      <h2>Explainer Panels</h2>
      <p class="desc">
        Collapsible panels give a human-readable breakdown of the scan: headline summary, raw signals, and practical next steps.
      </p>

      <div class="output-block" id="summaryBlock">
        <div class="collapse-header" id="summaryHeader">
          <span class="label">Primary threat summary</span>
          <span class="chevron" id="summaryChevron">▾</span>
        </div>
        <div class="collapse-body">
          <span class="muted" id="summaryText">No scan yet. Provide a URL and run Razor++ Scan.</span>
        </div>
      </div>

      <div class="output-block" id="detailsBlock">
        <div class="collapse-header" id="detailsHeader">
          <span class="label">Detailed findings</span>
          <span class="chevron" id="detailsChevron">▾</span>
        </div>
        <div class="collapse-body">
          <span class="muted" id="detailsText">Signals and flags will appear here after analysis.</span>
        </div>
      </div>

      <div class="output-block" id="actionsBlock">
        <div class="collapse-header" id="actionsHeader">
          <span class="label">Recommended actions</span>
          <span class="chevron" id="actionsChevron">▾</span>
        </div>
        <div class="collapse-body">
          <span class="muted" id="actionsText">Safety guidance will appear here based on the risk level.</span>
        </div>
      </div>
    </section>

    <!-- HISTORY SECTION -->
    <section class="section history-wrapper">
      <h2>Scan history (local)</h2>
      <p class="desc">Recent scans are stored only in this browser. Clear your storage to reset.</p>
      <div class="history-list" id="historyList">
        <div class="muted">No scans yet. Run a scan to see history here.</div>
      </div>
    </section>
  </div>
</div>


<footer>
  PROXUMA SHIELD Razor Prime v1.0 · Mobile-stacked heuristic prototype · Do not rely on this UI as a sole security decision-maker.
</footer>



<script>

// ---------- Theme handling ----------
(function initTheme() {
  const select = document.getElementById("themeSelect");
  const saved = window.localStorage.getItem("proxuma_theme_v10") || "neon";
  document.documentElement.setAttribute("data-theme", saved);
  select.value = saved;

  select.addEventListener("change", function() {
    const val = select.value;
    document.documentElement.setAttribute("data-theme", val);
    try {
      window.localStorage.setItem("proxuma_theme_v10", val);
    } catch (e) {}
  });
})();

// ---------- Utility helpers ----------
function looksLikeIP(host) {
  if (!host) return false;
  const parts = host.split(".");
  if (parts.length !== 4) return false;
  return parts.every(p => {
    const n = parseInt(p, 10);
    return !isNaN(n) && n >= 0 && n <= 255;
  });
}

function entropyScore(str) {
  if (!str) return 0;
  const s = String(str);
  const len = s.length;
  if (len < 12) return 0;
  const freq = {};
  for (let i = 0; i < len; i++) {
    const ch = s[i];
    freq[ch] = (freq[ch] || 0) + 1;
  }
  let entropy = 0;
  for (const ch in freq) {
    const p = freq[ch] / len;
    entropy -= p * Math.log2(p);
  }
  if (entropy < 3.5) return 0;
  if (entropy < 4.2) return 5;
  if (entropy < 4.8) return 10;
  return 15;
}

function hasZeroWidth(str) {
  if (!str) return false;
  return /[\u200B-\u200F\uFEFF]/.test(str);
}

function hasNonAsciiHostname(host) {
  if (!host) return false;
  for (let i = 0; i < host.length; i++) {
    if (host.charCodeAt(i) > 127) return true;
  }
  return false;
}

function hasFakeLockUnicode(str) {
  if (!str) return false;
  return /[\uD83D\uDD10\uD83D\uDD12]/.test(str); // lock emojis
}

function levenshtein(a, b) {
  if (!a) return b.length;
  if (!b) return a.length;
  const dp = Array(b.length + 1).fill(0).map(() => Array(a.length + 1).fill(0));
  for (let i = 0; i <= b.length; i++) dp[i][0] = i;
  for (let j = 0; j <= a.length; j++) dp[0][j] = j;
  for (let i = 1; i <= b.length; i++) {
    for (let j = 1; j <= a.length; j++) {
      if (b[i - 1] === a[j - 1]) {
        dp[i][j] = dp[i - 1][j - 1];
      } else {
        dp[i][j] = Math.min(
          dp[i - 1][j] + 1,
          dp[i][j - 1] + 1,
          dp[i - 1][j - 1] + 1
        );
      }
    }
  }
  return dp[b.length][a.length];
}

function normalizeLeet(str) {
  const map = {
    "0": "o",
    "1": "l",
    "3": "e",
    "4": "a",
    "5": "s",
    "7": "t",
    "8": "b"
  };
  let out = "";
  for (let i = 0; i < str.length; i++) {
    const ch = str[i];
    out += map[ch] || ch;
  }
  return out;
}

function leetSubCount(original, normalized) {
  let count = 0;
  const len = Math.min(original.length, normalized.length);
  for (let i = 0; i < len; i++) {
    if (original[i] !== normalized[i]) count++;
  }
  return count;
}

// ---------- URL analysis ----------
function analyzeUrl(url) {
  const info = {
    valid: false,
    https: false,
    host: "",
    tld: "",
    path: "",
    length: url ? url.length : 0,
    isIP: false,
    hasManySubdomains: false,
    hasSuspiciousTLD: false,
    hasLoginWords: false,
    trackingParams: false,
    brandHit: false,
    obfuscationFlags: [],
    entropyBoost: 0,
    repeatedWords: false,
    hasZeroWidth: false,
    hasNonAsciiHost: false,
    hasFakeLock: false,
    leetSubCount: 0,
    brandLeetImpersonation: false,
    wordLikeLeet: false,
    raw: url || ""
  };

  if (!url) return info;

  try {
    const u = new URL(url);
    info.valid = true;
    info.https = (u.protocol === "https:");
    info.host = u.hostname || "";
    info.path = u.pathname || "/";
    info.length = url.length;
    info.isIP = looksLikeIP(info.host);

    const hostParts = info.host.split(".");
    if (hostParts.length > 3) info.hasManySubdomains = true;
    const tld = hostParts[hostParts.length - 1].toLowerCase();
    info.tld = tld;

    const suspiciousTLDs = ["ru","cn","tk","gq","ml","ga","cf","work","zip","lol"];
    info.hasSuspiciousTLD = suspiciousTLDs.includes(tld);

    const lowerUrl = url.toLowerCase();
    let decodedUrl = url;
    try {
      decodedUrl = decodeURIComponent(url);
    } catch (e) {
      decodedUrl = url;
    }
    info.decodedSuspicious = /(login|signin|verify|reset|account|wallet|secure|password|passcode|2fa|bank|billing|support|invoice)/i.test(decodedUrl);
    const loginWords = ["login","signin","verify","reset","account","wallet","secure",
                        "update","security","check","password","auth","session"];
    info.hasLoginWords = loginWords.some(w => lowerUrl.includes(w));

    info.trackingParams = lowerUrl.includes("utm_") ||
                          lowerUrl.includes("gclid") ||
                          lowerUrl.includes("fbclid") ||
                          lowerUrl.includes("ref=") ||
                          lowerUrl.includes("campaign=");

    const hostLower = info.host.toLowerCase();
    const brandKeywords = [
      "google","paypal","apple","microsoft","facebook","meta","amazon","netflix",
      "bankofamerica","chase","td","rbc","gmail","outlook","yahoo","instagram",
      "telegram","whatsapp","binance","coinbase","twitter","x.com"
    ];
    info.brandHit = brandKeywords.some(b => hostLower.includes(b));

    const obf = [];
    if (url.includes("@")) obf.push("contains @ in URL");
    if (url.includes("%")) obf.push("percent-encoding present");
    if (url.includes("\\x")) obf.push("hex-style escapes");
    if (lowerUrl.includes("://bit.ly") ||
        lowerUrl.includes("://t.co") ||
        lowerUrl.includes("://tinyurl") ||
        lowerUrl.includes("://goo.gl")) {
      obf.push("shortener-style URL");
    }
    if (lowerUrl.includes("redirect=") || lowerUrl.includes("redir=")) {
      obf.push("redirect parameter");
    }
    if (lowerUrl.includes("url=") && lowerUrl.includes("http")) {
      obf.push("nested URL parameter");
    }
    info.obfuscationFlags = obf;

    const pathBits = info.path.split(/[-/_]+/).filter(Boolean);
    const wordCounts = {};
    pathBits.forEach(w => {
      const lw = w.toLowerCase();
      wordCounts[lw] = (wordCounts[lw] || 0) + 1;
    });
    info.repeatedWords = Object.values(wordCounts).some(c => c >= 3);

    const entropyTarget = (u.search || "") + "|" + (u.pathname || "");
    info.entropyBoost = entropyScore(entropyTarget);

    info.hasZeroWidth = hasZeroWidth(url);
    info.hasNonAsciiHost = hasNonAsciiHostname(info.host);
    info.hasFakeLock = hasFakeLockUnicode(url);

    const hostNorm = normalizeLeet(hostLower);
    const subCount = leetSubCount(hostLower, hostNorm);
    info.leetSubCount = subCount;

    const sld = hostLower.split(".").slice(-2, -1)[0] || "";
    const sldNorm = normalizeLeet(sld);
    if (sldNorm.match(/^[a-z]{5,}$/) && sldNorm !== sld) {
      info.wordLikeLeet = true;
    }

    for (const brand of brandKeywords) {
      if (hostNorm.includes(brand) && !hostLower.includes(brand)) {
        const dist = levenshtein(hostNorm, brand);
        if (dist <= 3) {
          info.brandLeetImpersonation = true;
          break;
        }
      }
    }

  } catch (e) {}

  return info;
}

// ---------- HTML analysis ----------
function analyzeHtml(html) {
  const res = {
    present: false,
    forms: 0,
    passwordFields: 0,
    scriptTags: 0,
    iframes: 0,
    dangerousWords: []
  };
  if (!html || !html.trim()) return res;
  res.present = true;

  const lower = html.toLowerCase();
  const matches = (pattern) => (lower.match(pattern) || []).length;

  res.forms = matches(/<form\b/gi);
  res.passwordFields = matches(/type=["']password["']/gi);
  res.scriptTags = matches(/<script\b/gi);
  res.iframes = matches(/<iframe\b/gi);

  const dangerList = [
    "crypto","seed phrase","metamask","bank","credit card",
    "2fa","one-time code","social security","private key","wallet","mnemonic"
  ];
  res.dangerousWords = dangerList.filter(w => lower.includes(w));

  return res;
}

// ---------- Scoring engine v1.0 RAZOR++ ----------
function computeScore(urlInfo, htmlInfo, context) {
  let score = 5;

  if (!urlInfo.valid && urlInfo.raw) score += 24;
  if (urlInfo.valid && !urlInfo.https) score += 22;

  if (urlInfo.hasSuspiciousTLD) score += 30;
  if (urlInfo.isIP) score += 15;
  if (urlInfo.hasManySubdomains) score += 13;
  if (urlInfo.length > 120) score += 8;
  if (urlInfo.length > 220) score += 8;

  if (urlInfo.hasLoginWords) score += 21;
  if (urlInfo.trackingParams) score += 4;
  if (urlInfo.brandHit) score += 12;

  if (urlInfo.obfuscationFlags.length > 0) {
    score += Math.min(8 + urlInfo.obfuscationFlags.length * 4, 20);
    if (urlInfo.obfuscationFlags.some(f => f.toLowerCase().includes("shortener-style url")) && score < 45) {
      score = 45;
    }
  }

  score += urlInfo.entropyBoost;

  if (urlInfo.repeatedWords) score += 8;

  if (urlInfo.hasZeroWidth) score += 25;
  if (urlInfo.hasNonAsciiHost) score += 28;
  if (urlInfo.hasNonAsciiHost) score += 10;
  if (urlInfo.hasFakeLock) score += 10;

  if (htmlInfo.present) {
    score += htmlInfo.forms * 4;
    score += htmlInfo.passwordFields * 11;
    score += Math.min(htmlInfo.scriptTags * 3, 15);
    score += Math.min(htmlInfo.iframes * 4, 18);
    score += htmlInfo.dangerousWords.length * 8;
  }

  if (urlInfo.brandLeetImpersonation) {
    score += 40;
  }
  if (urlInfo.wordLikeLeet && urlInfo.leetSubCount >= 1) {
    score += 12;
  }
  if (urlInfo.leetSubCount >= 2) {
    score += 6;
  }

  let credScore = 0;
  let financialScore = 0;
  let malwareScore = 0;

  if (urlInfo.hasLoginWords || htmlInfo.passwordFields > 0) credScore += 25;
  if (urlInfo.decodedSuspicious) credScore += 18;
  if (urlInfo.brandHit && urlInfo.hasLoginWords) credScore += 20;
  if (htmlInfo.dangerousWords.length > 0) credScore += 10;
  if (urlInfo.brandLeetImpersonation) credScore += 25;

  if (urlInfo.hasSuspiciousTLD) financialScore += 15;
  if (urlInfo.decodedSuspicious) financialScore += 10;
  if (htmlInfo.dangerousWords.some(w => w === "bank" || w === "credit card")) {
    financialScore += 20;
  }
  if (context.profile === "payment") financialScore += 15;

  if (urlInfo.entropyBoost >= 10 || urlInfo.obfuscationFlags.length > 0) malwareScore += 20;
  if (htmlInfo.scriptTags > 4 || htmlInfo.iframes > 2) malwareScore += 15;

  if (context.sensitivity === "high") {
    credScore *= 1.2;
    financialScore *= 1.2;
  }

  let multiplier = 1.0;
  if (context.sensitivity === "high") multiplier *= 1.2;
  if (context.profile === "payment") multiplier *= 1.25;
  if (context.profile === "login") multiplier *= 1.15;
  if (context.profile === "email") multiplier *= 1.2;

  score *= multiplier;

  if (urlInfo.hasNonAsciiHost && urlInfo.brandHit && score < 80) {
    score = 80;
  }
  if (urlInfo.hasZeroWidth && urlInfo.host && score < 45) {
    score = 45;
  }

  let redFlags = 0;
  if (urlInfo.hasSuspiciousTLD) redFlags++;
  if (urlInfo.hasManySubdomains) redFlags++;
  if (urlInfo.hasLoginWords) redFlags++;
  if (urlInfo.brandHit) redFlags++;
  if (urlInfo.obfuscationFlags.length > 0) redFlags++;
  if (urlInfo.entropyBoost >= 10) redFlags++;
  if (urlInfo.hasNonAsciiHost || urlInfo.hasZeroWidth) redFlags++;
  if (urlInfo.brandLeetImpersonation || urlInfo.wordLikeLeet) redFlags++;

  if (redFlags >= 3) score *= 1.12;
  if (redFlags >= 4) score *= 1.22;
  if (redFlags >= 5) score *= 1.32;

  let minScore = 0;

  if (urlInfo.hasSuspiciousTLD && urlInfo.hasManySubdomains) {
    minScore = Math.max(minScore, 72);
  }
  if (urlInfo.hasSuspiciousTLD && urlInfo.hasLoginWords) {
    minScore = Math.max(minScore, 78);
  }
  if (urlInfo.hasSuspiciousTLD && urlInfo.brandHit && (urlInfo.hasLoginWords || urlInfo.hasManySubdomains)) {
    minScore = Math.max(minScore, 92);
  }
  if (urlInfo.brandHit && urlInfo.hasLoginWords && (urlInfo.obfuscationFlags.length > 0 || urlInfo.entropyBoost >= 10)) {
    minScore = Math.max(minScore, 88);
  }
  if (urlInfo.brandLeetImpersonation) {
    minScore = Math.max(minScore, 90);
  }

  if (!urlInfo.raw && htmlInfo.present) {
    if (score > 60) score = 60;
  }

  if (score < minScore) score = minScore;

  if (score < 0) score = 0;
  if (score > 100) score = 100;

  return {
    total: Math.round(score),
    credential: Math.round(Math.max(0, Math.min(100, credScore))),
    financial: Math.round(Math.max(0, Math.min(100, financialScore))),
    malware: Math.round(Math.max(0, Math.min(100, malwareScore)))
  };
}

// ---------- Presentation helpers ----------
function riskLabel(score) {
  if (score < 35) return { label: "Low", css: "risk-low" };
  if (score < 70) return { label: "Medium", css: "risk-medium" };
  return { label: "High", css: "risk-high" };
}

function summarize(urlInfo, htmlInfo, scores) {
  const score = scores.total;
  if (!urlInfo.raw) {
    return "No URL provided. Enter a URL and run Razor++ Scan to generate a risk snapshot.";
  }

  const base = `This link was evaluated using local heuristic checks only. The current risk score is ${score}/100.`;

  if (!urlInfo.valid) {
    return base + " The URL could not be parsed reliably, which itself may indicate tampering or copy-paste errors. Treat with caution.";
  }

  const parts = [];

  if (!urlInfo.https) {
    parts.push("The connection is not using HTTPS, so data in transit could potentially be intercepted or modified.");
  } else {
    parts.push("The connection is using HTTPS, which helps protect data in transit, but does not guarantee the site is trustworthy.");
  }

  if (urlInfo.hasSuspiciousTLD) {
    parts.push("The top-level domain is associated with higher abuse rates or disposable hosting.");
  }

  if (urlInfo.isIP) {
    parts.push("The link goes directly to an IP address rather than a named domain, which is unusual for mainstream services.");
  }

  if (urlInfo.hasManySubdomains) {
    parts.push("The domain contains multiple nested subdomains, which attackers sometimes use to mimic legitimate brands.");
  }

  if (urlInfo.brandHit) {
    parts.push("The hostname appears to reference a well-known brand, which can be used in phishing to create a false sense of legitimacy.");
  }

  if (urlInfo.hasLoginWords) {
    parts.push("The URL path or query suggests login, account, or security activity, which raises the impact if this link is malicious.");
  }

  if (urlInfo.obfuscationFlags.length) {
    parts.push("Obfuscation or redirection-style patterns detected: " + urlInfo.obfuscationFlags.join(", ") + ".");
  }

  if (urlInfo.entropyBoost >= 10) {
    parts.push("The structure of the path or query parameters appears highly random, which is common in tracking or exploit payloads.");
  }

  if (urlInfo.hasZeroWidth || urlInfo.hasNonAsciiHost) {
    parts.push("The domain or URL contains invisible or non-standard characters, which can be used for lookalike or homoglyph attacks.");
  }

  if (urlInfo.wordLikeLeet) {
    parts.push("The domain resembles a word but uses letter-to-number substitutions, which is a common lookalike pattern.");
  }

  if (urlInfo.brandLeetImpersonation) {
    parts.push("The domain appears to imitate a well-known brand name using character substitutions, a strong phishing indicator.");
  }

  if (htmlInfo.present) {
    if (htmlInfo.passwordFields > 0) {
      parts.push("The HTML appears to contain password input fields.");
    }
    if (htmlInfo.scriptTags > 0) {
      parts.push("The page includes active scripts that could modify content or capture data.");
    }
    if (htmlInfo.iframes > 0) {
      parts.push("Embedded iframes are present, which can be used for tracking, overlays, or hidden content injection.");
    }
    if (htmlInfo.dangerousWords.length > 0) {
      parts.push("Sensitive finance or wallet-related keywords detected in the HTML: " + htmlInfo.dangerousWords.join(", ") + ".");
    }
  }

  if (!parts.length) {
    parts.push("No strong red-flag patterns were detected by this prototype, but this does not guarantee safety.");
  }

  return base + " " + parts.join(" ");
}

function buildDetailsText(urlInfo, htmlInfo, scores) {
  const lines = [];

  lines.push("Risk profile:");
  lines.push("  • Credential theft risk: " + scores.credential + "/100");
  lines.push("  • Financial theft risk: " + scores.financial + "/100");
  lines.push("  • Malware / exploit risk: " + scores.malware + "/100");
  lines.push("");
  lines.push("URL analysis:");
  lines.push("  • Parsed: " + (urlInfo.valid ? "yes" : "no"));
  lines.push("  • HTTPS: " + (urlInfo.https ? "yes" : "no"));
  lines.push("  • Host: " + (urlInfo.host || "–"));
  lines.push("  • TLD: " + (urlInfo.tld || "–"));
  lines.push("  • Path: " + (urlInfo.path || "–"));
  lines.push("  • Length: " + urlInfo.length + " characters");
  lines.push("  • Uses IP as host: " + (urlInfo.isIP ? "yes" : "no"));
  lines.push("  • Many subdomains: " + (urlInfo.hasManySubdomains ? "yes" : "no"));
  lines.push("  • Suspicious TLD: " + (urlInfo.hasSuspiciousTLD ? "yes" : "no"));
  lines.push("  • Brand-like hostname: " + (urlInfo.brandHit ? "yes" : "no"));
  lines.push("  • Login / security words: " + (urlInfo.hasLoginWords ? "yes" : "no"));
  lines.push("  • Tracking parameters: " + (urlInfo.trackingParams ? "yes" : "no"));
  lines.push("  • Obfuscation signals: " + (urlInfo.obfuscationFlags.length ? urlInfo.obfuscationFlags.join(", ") : "none"));
  lines.push("  • High-entropy pattern boost: " + urlInfo.entropyBoost);
  lines.push("  • Zero-width characters in URL: " + (urlInfo.hasZeroWidth ? "yes" : "no"));
  lines.push("  • Non-ASCII characters in host: " + (urlInfo.hasNonAsciiHost ? "yes" : "no"));
  lines.push("  • Leet substitutions in host: " + urlInfo.leetSubCount);
  lines.push("  • Word-like with substitutions: " + (urlInfo.wordLikeLeet ? "yes" : "no"));
  lines.push("  • Brand leet impersonation: " + (urlInfo.brandLeetImpersonation ? "yes" : "no"));
  lines.push("");
  lines.push("HTML analysis:");
  lines.push("  • Provided: " + (htmlInfo.present ? "yes" : "no"));
  if (htmlInfo.present) {
    lines.push("  • <form> tags: " + htmlInfo.forms);
    lines.push("  • password-type inputs: " + htmlInfo.passwordFields);
    lines.push("  • <script> tags: " + htmlInfo.scriptTags);
    lines.push("  • <iframe> tags: " + htmlInfo.iframes);
    lines.push("  • Sensitive keywords: " + (htmlInfo.dangerousWords.length ? htmlInfo.dangerousWords.join(", ") : "none"));
  } else {
    lines.push("  • No HTML body was provided for inspection.");
  }

  return lines.join("\n");
}

function buildActionsText(score) {
  const baseAdvice = [
    "• Never enter passwords, recovery phrases, or payment details on a page you do not fully trust.",
    "• When in doubt, navigate to the site manually instead of clicking on links from email or chat.",
    "• Compare the domain carefully against the official site (extra letters, dashes, or strange endings can indicate phishing)."
  ];

  if (score >= 70) {
    return [
      "This prototype flags the link as HIGH RISK based on the observable patterns.",
      "Recommended actions:",
      "• Avoid entering any personal or financial information on this page.",
      "• Close the tab and, if this appeared in an email or message, treat the message as suspicious.",
      "• If this claims to be from a known service (bank, email, wallet), go directly to the official site instead.",
      "",
      ...baseAdvice
    ].join("\n");
  } else if (score >= 35) {
    return [
      "This prototype flags the link as MEDIUM RISK. Several caution signals are present.",
      "Recommended actions:",
      "• Proceed only if you initiated this action and you fully trust the source.",
      "• Double-check the domain spelling and the page content for anything unusual.",
      "",
      ...baseAdvice
    ].join("\n");
  } else {
    return [
      "This prototype flags the link as LOW RISK based on its limited heuristic checks.",
      "However, low risk does NOT mean no risk.",
      "Recommended actions:",
      "• Continue to apply normal caution and verify the site before entering sensitive information.",
      "",
      ...baseAdvice
    ].join("\n");
  }
}

// ---------- History handling ----------
function loadHistory() {
  try {
    const raw = window.localStorage.getItem("proxuma_history_v10");
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return [];
    return parsed;
  } catch (e) {
    return [];
  }
}

function saveHistory(list) {
  try {
    window.localStorage.setItem("proxuma_history_v10", JSON.stringify(list));
  } catch (e) {}
}

function renderHistory() {
  const container = document.getElementById("historyList");
  const history = loadHistory();
  container.innerHTML = "";
  if (!history.length) {
    const div = document.createElement("div");
    div.className = "muted";
    div.textContent = "No scans yet. Run a scan to see history here.";
    container.appendChild(div);
    return;
  }

  history.forEach(item => {
    const card = document.createElement("div");
    card.className = "history-item";

    const top = document.createElement("div");
    top.className = "history-top";

    const urlSpan = document.createElement("div");
    urlSpan.className = "history-url";
    urlSpan.textContent = item.url || "(no URL)";

    const tag = document.createElement("div");
    tag.className = "history-tag";
    tag.textContent = item.level + " · " + item.score;

    top.appendChild(urlSpan);
    top.appendChild(tag);

    const meta = document.createElement("div");
    meta.className = "history-meta";
    const left = document.createElement("span");
    left.textContent = "Domain: " + (item.domain || "–");
    const right = document.createElement("span");
    right.textContent = item.time;
    meta.appendChild(left);
    meta.appendChild(right);

    card.appendChild(top);
    card.appendChild(meta);
    container.appendChild(card);
  });
}

// ---------- Collapse toggles ----------
function toggleBlock(id) {
  const block = document.getElementById(id + "Block");
  if (!block) return;
  block.classList.toggle("collapsed");
}

document.getElementById("summaryHeader").addEventListener("click", function () {
  toggleBlock("summary");
});
document.getElementById("detailsHeader").addEventListener("click", function () {
  toggleBlock("details");
});
document.getElementById("actionsHeader").addEventListener("click", function () {
  toggleBlock("actions");
});

renderHistory();

// ---------- Scan handler ----------
document.getElementById("scanBtn").addEventListener("click", function () {
  const url = document.getElementById("url").value.trim();
  const html = document.getElementById("html").value;
  const profile = document.getElementById("profile").value;
  const sensitivity = document.getElementById("sensitivity").value;

  const urlInfo = analyzeUrl(url);
  const htmlInfo = analyzeHtml(html);
  const scores = computeScore(urlInfo, htmlInfo, { profile, sensitivity });
  const totalScore = scores.total;
  const labelInfo = riskLabel(totalScore);

  document.getElementById("scoreValue").innerText = isNaN(totalScore) ? "–" : String(totalScore);
  const meter = document.getElementById("meterFill");
  meter.style.width = (isNaN(totalScore) ? 0 : totalScore) + "%";

  const tag = document.getElementById("riskTag");
  tag.textContent = labelInfo.label + " risk";
  tag.className = "risk-tag " + labelInfo.css;

  document.getElementById("httpsMeta").innerText =
    urlInfo.valid ? (urlInfo.https ? "HTTPS in use" : "No HTTPS detected") : "Unparseable URL";

  document.getElementById("domainMeta").innerText =
    "Domain: " + (urlInfo.host || "–");

  const structBits = [];
  if (urlInfo.length > 120) structBits.push("very long URL");
  if (urlInfo.length > 220) structBits.push("extremely long URL");
  if (urlInfo.hasManySubdomains) structBits.push("many subdomains");
  if (urlInfo.isIP) structBits.push("direct IP host");
  if (!structBits.length) structBits.push("no major structural flags");
  document.getElementById("structureMeta").innerText = structBits.join(", ");

  const extraBits = [];
  if (urlInfo.hasSuspiciousTLD) extraBits.push("TLD pattern flagged");
  if (urlInfo.brandHit) extraBits.push("brand-looking hostname");
  if (urlInfo.hasLoginWords) extraBits.push("login/security keywords");
  if (urlInfo.trackingParams) extraBits.push("tracking parameters");
  if (urlInfo.obfuscationFlags.length) extraBits.push("obfuscation signals");
  if (urlInfo.entropyBoost >= 10) extraBits.push("high-entropy pattern");
  if (urlInfo.hasZeroWidth || urlInfo.hasNonAsciiHost) extraBits.push("homoglyph / invisible-char risk");
  if (urlInfo.wordLikeLeet || urlInfo.brandLeetImpersonation) extraBits.push("lookalike / leet pattern");
  if (!extraBits.length) extraBits.push("no extra signals");
  document.getElementById("extrasMeta").innerText = "Signals: " + extraBits.join(" · ");

  document.getElementById("summaryText").textContent = summarize(urlInfo, htmlInfo, scores);

  const detailsStr = buildDetailsText(urlInfo, htmlInfo, scores);
  document.getElementById("detailsText").innerHTML = detailsStr.replace(/\n/g, "<br>");

  const actionsStr = buildActionsText(totalScore);
  document.getElementById("actionsText").innerHTML = actionsStr.replace(/\n/g, "<br>");

  const cred = scores.credential;
  const fin = scores.financial;
  const mal = scores.malware;
  document.getElementById("credMeter").style.width = (isNaN(cred) ? 0 : cred) + "%";
  document.getElementById("finMeter").style.width = (isNaN(fin) ? 0 : fin) + "%";
  document.getElementById("malMeter").style.width = (isNaN(mal) ? 0 : mal) + "%";
  document.getElementById("credValue").innerText = isNaN(cred) ? "–" : cred;
  document.getElementById("finValue").innerText = isNaN(fin) ? "–" : fin;
  document.getElementById("malValue").innerText = isNaN(mal) ? "–" : mal;

  const history = loadHistory();
  const entry = {
    url: url || "(no URL)",
    domain: urlInfo.host || "",
    score: totalScore,
    level: labelInfo.label,
    time: new Date().toLocaleString()
  };
  history.unshift(entry);
  if (history.length > 25) history.length = 25;
  saveHistory(history);
  renderHistory();
});

</script>

</body>
</html>
